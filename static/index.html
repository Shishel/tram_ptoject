<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Карта с кастомными метками</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=0f0cb27e-11ce-400f-af08-b552d5546e3c&lang=ru_RU"></script>
    <style>
        html, body, #map { width: 100%; height: 100%; margin: 0; padding: 0; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        let map;
        let placemarks = []; // Массив для хранения всех меток

        ymaps.ready(() => {
            map = new ymaps.Map("map", {
                center: [45.035470, 38.975313],
                zoom: 12
            });

            updateTrams(); // Первичная загрузка меток
            setInterval(updateTrams, 5000); // Обновляем данные каждые 5 секунд
        });

        function updateTrams() {
            fetch('http://127.0.0.1:5000/api/trams')
                .then(response => response.json())
                .then(data => {
                    console.log('Получены данные:', data);  // Логируем полученные данные

                    // Проверяем, что данные не пустые
                    if (data.length === 0) {
                        console.log("Нет данных для отображения");
                        return;
                    }

                    // Удаляем все старые метки
                    placemarks.forEach(placemark => {
                        map.geoObjects.remove(placemark);
                    });
                    placemarks = []; // Очищаем массив меток

                    // Перебираем данные и добавляем новые метки
                    data.forEach(item => {
                        const coordinates = [item.lat, item.lon];

                        // Определяем путь к иконке в зависимости от типа транспорта
                        let iconImageHref = '';
                        switch(item.type) {
                            case '4':
                                iconImageHref = '/static/images/service_test.png';  // Сервис
                                break;
                            case '3':
                                iconImageHref = '/static/images/tram_test.png';     // Трамвай
                                break;
                            case '2':
                                iconImageHref = '/static/images/bus.png';      // Автобус
                                break;
                            case '1':
                                iconImageHref = '/static/images/trol.png'; // Троллейбус
                                break;
                            default:
                                iconImageHref = '/static/images/default.png';  // По умолчанию
                                break;
                        }

                        // Создаем новую метку с кастомной иконкой
                        const placemark = new ymaps.Placemark(coordinates, {
                            iconContent: item.route,  // Отображаем номер маршрута прямо на метке
                        }, {
                            iconLayout: 'default#image',
                            iconImageHref: iconImageHref,  // Используем кастомную иконку
                            iconImageSize: [30, 30],  // Размер иконки
                            iconImageOffset: [-15, -15]  // Смещение иконки
                        });

                        // Добавляем метку на карту
                        map.geoObjects.add(placemark);
                        placemarks.push(placemark); // Сохраняем метку в массиве
                    });
                })
                .catch(error => {
                    console.error("Ошибка при получении данных с API:", error);
                });
        }
    </script>
</body>
</html>